name: Build site
on:
  push:
    branches:
      - master-v2
jobs:
  build_and_upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2

      - name: Cache Bun and Next.js dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            ~/.npm
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-bun-nextjs-${{ hashFiles('**/bun.lockb', '**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-bun-nextjs-${{ hashFiles('**/bun.lockb', '**/package-lock.json') }}-

      - name: Install dependencies with Bun
        run: bun install

      - name: Build the project
        run: bun run build

      - name: Install lftp (FTP client)
        run: sudo apt-get install -y lftp

      - name: Upload built files to FTP
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          BUILD_DIR='./out'
          lftp -u $FTP_USERNAME,$FTP_PASSWORD $FTP_SERVER <<EOF
          cd /domains/justinnn.dev/public_html/new/
          rm -r ./
          mirror -R $BUILD_DIR/ ./
          quit
          EOF